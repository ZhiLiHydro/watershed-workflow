FROM continuumio/miniconda3 AS environ
#
# Stage 1 -- setup environment
#
LABEL Description="Environment Docker Container for Watershed Workflow"

RUN mkdir /ww
WORKDIR /ww

# set the workdir as the user's home directory
COPY environment.yml /ww/environment.yml
COPY requirements.txt /ww/requirements.txt

# create an environment based on yml file
RUN conda env create -f environment.yml && \
    conda clean -afy

# add extras pip
RUN conda install -c conda-forge -n watershed_workflow --yes --freeze-installed pip

# add pip-only packages
RUN conda run -n watershed_workflow python -m pip install -r requirements.txt

# pack the environment into a new directory
# -- install conda-pack in the MAIN conda -- we won't move this to the env
RUN conda install -c conda-forge --yes --freeze-installed conda-pack
RUN conda-pack -n watershed_workflow -o /tmp/env.tar && \
    mkdir /ww_env && cd /ww_env && tar xf /tmp/env.tar && \
    rm /tmp/env.tar 

# We've put env in same path it'll be in final image,
# so now fix up paths:
RUN /ww_env/bin/conda-unpack

#
# Stage 2 -- clone repo run
#
FROM ubuntu:20.04 AS watershed_workflow_env

COPY --from=environ /opt/conda/envs/watershed_workflow /opt
ENV PATH="/opt/bin:${PATH}"
ENV WATERSHED_WORKFLOW_DIR=/ww

